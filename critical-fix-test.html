<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚨 Critical Fix Test - LP Staking Platform</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: var(--liberdus-bg-secondary);
            border-radius: 0.5rem;
            border: 1px solid var(--liberdus-border-primary);
        }
        
        .test-result {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.375rem;
            font-family: 'Courier New', monospace;
        }
        
        .success { background: var(--liberdus-green-bg); color: var(--liberdus-green); }
        .error { background: var(--liberdus-red-bg); color: var(--liberdus-red); }
        .warning { background: var(--liberdus-orange-bg); color: var(--liberdus-orange); }
        .info { background: var(--liberdus-blue-bg); color: var(--liberdus-blue); }
        
        .test-button {
            background: var(--liberdus-blue);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 1rem;
            margin: 0.5rem;
        }
        
        .test-button:hover {
            background: var(--liberdus-blue-light);
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 style="text-align: center; color: var(--liberdus-text-primary); margin-bottom: 2rem;">
            🚨 Critical Fix Validation Test
        </h1>
        
        <div id="test-results">
            <div class="test-result info">
                ℹ️ Click "Run Critical Tests" to validate all fixes
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 2rem;">
            <button class="test-button" onclick="runCriticalTests()">🧪 Run Critical Tests</button>
            <button class="test-button" onclick="testMainApp()">🚀 Test Main App</button>
            <button class="test-button" onclick="clearResults()">🗑️ Clear Results</button>
        </div>
    </div>

    <!-- Required DOM Elements -->
    <main id="app-content" class="main-content" style="display: none;"></main>
    <div id="notification-container" class="notification-container"></div>
    <div id="modal-container" class="modal-container"></div>

    <!-- Scripts in Fixed Order -->
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    
    <script>
        // Test Results Storage
        let testResults = [];
        
        function addResult(type, message) {
            testResults.push({ type, message, timestamp: Date.now() });
            updateDisplay();
        }
        
        function updateDisplay() {
            const container = document.getElementById('test-results');
            if (testResults.length === 0) {
                container.innerHTML = '<div class="test-result info">ℹ️ No tests run yet</div>';
                return;
            }
            
            container.innerHTML = testResults.map(result => {
                const icon = result.type === 'success' ? '✅' : 
                           result.type === 'error' ? '❌' : 
                           result.type === 'warning' ? '⚠️' : 'ℹ️';
                return `<div class="test-result ${result.type}">${icon} ${result.message}</div>`;
            }).join('');
        }
        
        function clearResults() {
            testResults = [];
            updateDisplay();
        }
        
        async function runCriticalTests() {
            clearResults();
            addResult('info', 'Starting critical validation tests...');
            
            // Test 1: Check for redeclaration errors
            try {
                if (window.StateManager && window.ErrorHandler && window.EventManager && window.Router) {
                    addResult('success', 'All core classes are properly declared');
                } else {
                    addResult('error', 'Some core classes are missing');
                }
            } catch (error) {
                addResult('error', `Class declaration error: ${error.message}`);
            }
            
            // Test 2: Check singleton instances
            try {
                const instances = [
                    { name: 'stateManager', instance: window.stateManager },
                    { name: 'errorHandler', instance: window.errorHandler },
                    { name: 'eventManager', instance: window.eventManager },
                    { name: 'router', instance: window.router }
                ];
                
                let allInitialized = true;
                for (const { name, instance } of instances) {
                    if (!instance) {
                        addResult('error', `${name} instance not created`);
                        allInitialized = false;
                    } else if (instance.error) {
                        addResult('warning', `${name} initialized with error: ${instance.error}`);
                    } else {
                        addResult('success', `${name} initialized successfully`);
                    }
                }
                
                if (allInitialized) {
                    addResult('success', 'All singleton instances created');
                }
            } catch (error) {
                addResult('error', `Instance check error: ${error.message}`);
            }
            
            // Test 3: Check DOM elements
            try {
                const requiredElements = ['#app-content', '#notification-container', '#modal-container'];
                let allFound = true;
                
                for (const selector of requiredElements) {
                    const element = document.querySelector(selector);
                    if (element) {
                        addResult('success', `DOM element ${selector} found`);
                    } else {
                        addResult('error', `DOM element ${selector} missing`);
                        allFound = false;
                    }
                }
                
                if (allFound) {
                    addResult('success', 'All required DOM elements present');
                }
            } catch (error) {
                addResult('error', `DOM check error: ${error.message}`);
            }
            
            // Test 4: Test StateManager functionality
            try {
                if (window.stateManager && typeof window.stateManager.set === 'function') {
                    window.stateManager.set('test.value', 'hello');
                    const value = window.stateManager.get('test.value');
                    
                    if (value === 'hello') {
                        addResult('success', 'StateManager basic functionality working');
                    } else {
                        addResult('error', 'StateManager set/get not working correctly');
                    }
                } else {
                    addResult('error', 'StateManager methods not available');
                }
            } catch (error) {
                addResult('error', `StateManager test error: ${error.message}`);
            }
            
            // Test 5: Test ErrorHandler functionality
            try {
                if (window.errorHandler && typeof window.errorHandler.processError === 'function') {
                    const testError = new Error('Test error');
                    const processed = window.errorHandler.processError(testError);
                    
                    if (processed && processed.category) {
                        addResult('success', 'ErrorHandler basic functionality working');
                    } else {
                        addResult('error', 'ErrorHandler not processing errors correctly');
                    }
                } else {
                    addResult('error', 'ErrorHandler methods not available');
                }
            } catch (error) {
                addResult('error', `ErrorHandler test error: ${error.message}`);
            }
            
            // Test 6: Check for console errors
            const errorCount = window.debugErrors ? window.debugErrors.length : 0;
            if (errorCount === 0) {
                addResult('success', 'No console errors detected');
            } else {
                addResult('warning', `${errorCount} console errors detected - check browser console`);
            }
            
            // Final summary
            const successCount = testResults.filter(r => r.type === 'success').length;
            const errorCount2 = testResults.filter(r => r.type === 'error').length;
            const warningCount = testResults.filter(r => r.type === 'warning').length;
            
            if (errorCount2 === 0) {
                addResult('success', `🎉 All critical tests passed! (${successCount} successes, ${warningCount} warnings)`);
            } else {
                addResult('error', `❌ ${errorCount2} critical errors found. Fix these before proceeding.`);
            }
        }
        
        async function testMainApp() {
            addResult('info', 'Testing main application initialization...');
            
            try {
                // Check if we can navigate to main app
                window.location.href = 'index.html';
                addResult('success', 'Redirecting to main application...');
            } catch (error) {
                addResult('error', `Main app test error: ${error.message}`);
            }
        }
        
        // Error tracking
        window.debugErrors = [];
        const originalError = console.error;
        console.error = function(...args) {
            window.debugErrors.push({
                message: args.join(' '),
                timestamp: Date.now()
            });
            originalError.apply(console, args);
        };
    </script>

    <!-- Load Core Scripts -->
    <script src="config/constants.js"></script>
    <script src="js/utils/helpers.js"></script>
    <script src="js/core/error-handler.js"></script>
    <script src="js/core/state-manager.js"></script>
    <script src="js/core/event-manager.js"></script>
    <script src="js/core/router.js"></script>
    
    <script>
        // Auto-run tests when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚨 Critical Fix Test loaded');
            setTimeout(() => {
                addResult('info', 'Page loaded successfully - ready for testing');
            }, 500);
        });
    </script>
</body>
</html>
