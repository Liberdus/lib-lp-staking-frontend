<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚨 Initialization Debug - LP Staking Platform</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <style>
        .debug-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            font-family: 'Courier New', monospace;
        }
        
        .debug-section {
            margin: 1.5rem 0;
            padding: 1rem;
            background: var(--liberdus-bg-secondary);
            border: 1px solid var(--liberdus-border-primary);
            border-radius: 0.5rem;
        }
        
        .debug-title {
            color: var(--liberdus-text-primary);
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .status-success {
            color: var(--liberdus-green);
            background: var(--liberdus-green-bg);
            padding: 0.5rem;
            border-radius: 0.25rem;
            margin: 0.25rem 0;
        }
        
        .status-error {
            color: var(--liberdus-red);
            background: var(--liberdus-red-bg);
            padding: 0.5rem;
            border-radius: 0.25rem;
            margin: 0.25rem 0;
        }
        
        .status-warning {
            color: var(--liberdus-orange);
            background: var(--liberdus-orange-bg);
            padding: 0.5rem;
            border-radius: 0.25rem;
            margin: 0.25rem 0;
        }
        
        .status-info {
            color: var(--liberdus-blue);
            background: var(--liberdus-blue-bg);
            padding: 0.5rem;
            border-radius: 0.25rem;
            margin: 0.25rem 0;
        }
        
        .debug-button {
            background: var(--liberdus-blue);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            margin: 0.25rem;
            font-size: 0.875rem;
        }
        
        .debug-button:hover {
            background: var(--liberdus-blue-light);
        }
        
        .code-block {
            background: #1a1a1a;
            color: #f8f8f2;
            padding: 1rem;
            border-radius: 0.375rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            overflow-x: auto;
            margin: 0.5rem 0;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1 style="text-align: center; color: var(--liberdus-text-primary); margin-bottom: 2rem;">
            🚨 LP Staking Platform - Initialization Debug
        </h1>
        
        <!-- System Status Overview -->
        <div class="debug-section">
            <div class="debug-title">🔍 System Status Overview</div>
            <div id="system-overview">
                <div class="status-info">Initializing system checks...</div>
            </div>
            <button class="debug-button" onclick="runSystemCheck()">🔄 Refresh System Check</button>
        </div>
        
        <!-- Script Loading Status -->
        <div class="debug-section">
            <div class="debug-title">📜 Script Loading Status</div>
            <div id="script-status">
                <div class="status-info">Checking script loading...</div>
            </div>
        </div>
        
        <!-- Core Systems Status -->
        <div class="debug-section">
            <div class="debug-title">⚙️ Core Systems Status</div>
            <div id="core-systems-status">
                <div class="status-info">Checking core systems...</div>
            </div>
        </div>
        
        <!-- DOM Elements Status -->
        <div class="debug-section">
            <div class="debug-title">🏗️ DOM Elements Status</div>
            <div id="dom-status">
                <div class="status-info">Checking DOM elements...</div>
            </div>
        </div>
        
        <!-- Initialization Sequence -->
        <div class="debug-section">
            <div class="debug-title">🚀 Initialization Sequence</div>
            <div id="init-sequence">
                <div class="status-info">Ready to test initialization...</div>
            </div>
            <button class="debug-button" onclick="testInitialization()">🧪 Test App Initialization</button>
        </div>
        
        <!-- Error Log -->
        <div class="debug-section">
            <div class="debug-title">📋 Error Log</div>
            <div id="error-log">
                <div class="status-info">No errors logged yet...</div>
            </div>
            <button class="debug-button" onclick="clearErrorLog()">🗑️ Clear Error Log</button>
        </div>
        
        <!-- Recommendations -->
        <div class="debug-section">
            <div class="debug-title">💡 Recommendations</div>
            <div id="recommendations">
                <div class="status-info">Run system check to get recommendations...</div>
            </div>
        </div>
    </div>

    <!-- Main Content Container (Required for App) -->
    <main id="app-content" class="main-content" style="display: none;">
        <!-- This container is required for the app to initialize -->
    </main>

    <!-- Load Scripts in Correct Order -->
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        // Global error tracking
        window.debugErrors = [];
        window.debugLogs = [];
        
        // Override console methods to capture errors
        const originalError = console.error;
        const originalLog = console.log;
        const originalWarn = console.warn;
        
        console.error = function(...args) {
            window.debugErrors.push({
                type: 'error',
                message: args.join(' '),
                timestamp: new Date().toISOString(),
                stack: new Error().stack
            });
            originalError.apply(console, args);
            updateErrorLog();
        };
        
        console.warn = function(...args) {
            window.debugErrors.push({
                type: 'warning',
                message: args.join(' '),
                timestamp: new Date().toISOString()
            });
            originalWarn.apply(console, args);
            updateErrorLog();
        };
        
        console.log = function(...args) {
            if (args[0] && args[0].includes && (args[0].includes('✅') || args[0].includes('❌'))) {
                window.debugLogs.push({
                    type: 'info',
                    message: args.join(' '),
                    timestamp: new Date().toISOString()
                });
                updateErrorLog();
            }
            originalLog.apply(console, args);
        };
        
        function updateErrorLog() {
            const errorLogDiv = document.getElementById('error-log');
            if (!errorLogDiv) return;
            
            const allLogs = [...window.debugErrors, ...window.debugLogs]
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 10);
            
            if (allLogs.length === 0) {
                errorLogDiv.innerHTML = '<div class="status-info">No errors logged yet...</div>';
                return;
            }
            
            errorLogDiv.innerHTML = allLogs.map(log => {
                const statusClass = log.type === 'error' ? 'status-error' : 
                                  log.type === 'warning' ? 'status-warning' : 'status-info';
                return `<div class="${statusClass}">[${log.timestamp}] ${log.message}</div>`;
            }).join('');
        }
        
        function clearErrorLog() {
            window.debugErrors = [];
            window.debugLogs = [];
            updateErrorLog();
        }
        
        // System check functions
        function checkScriptLoading() {
            const scripts = [
                { name: 'Ethers.js', check: () => typeof window.ethers !== 'undefined' },
                { name: 'CONFIG', check: () => typeof window.CONFIG !== 'undefined' },
                { name: 'ErrorHandler', check: () => typeof window.ErrorHandler !== 'undefined' },
                { name: 'StateManager', check: () => typeof window.StateManager !== 'undefined' },
                { name: 'EventManager', check: () => typeof window.EventManager !== 'undefined' }
            ];
            
            const results = scripts.map(script => ({
                name: script.name,
                loaded: script.check(),
                status: script.check() ? 'success' : 'error'
            }));
            
            const scriptStatusDiv = document.getElementById('script-status');
            scriptStatusDiv.innerHTML = results.map(result => {
                const statusClass = result.status === 'success' ? 'status-success' : 'status-error';
                const icon = result.status === 'success' ? '✅' : '❌';
                return `<div class="${statusClass}">${icon} ${result.name}: ${result.loaded ? 'Loaded' : 'Not Loaded'}</div>`;
            }).join('');
            
            return results;
        }
        
        function checkCoreSystemsStatus() {
            const systems = [
                { name: 'errorHandler', instance: window.errorHandler },
                { name: 'stateManager', instance: window.stateManager },
                { name: 'eventManager', instance: window.eventManager }
            ];
            
            const results = systems.map(system => {
                let status = 'error';
                let message = 'Not initialized';
                
                if (system.instance) {
                    if (system.instance.error) {
                        status = 'error';
                        message = `Error: ${system.instance.error}`;
                    } else if (system.instance.initialized === false) {
                        status = 'warning';
                        message = 'Initialized with errors';
                    } else {
                        status = 'success';
                        message = 'Initialized successfully';
                    }
                }
                
                return { name: system.name, status, message };
            });
            
            const coreStatusDiv = document.getElementById('core-systems-status');
            coreStatusDiv.innerHTML = results.map(result => {
                const statusClass = result.status === 'success' ? 'status-success' : 
                                  result.status === 'warning' ? 'status-warning' : 'status-error';
                const icon = result.status === 'success' ? '✅' : 
                           result.status === 'warning' ? '⚠️' : '❌';
                return `<div class="${statusClass}">${icon} ${result.name}: ${result.message}</div>`;
            }).join('');
            
            return results;
        }
        
        function checkDOMElements() {
            const elements = [
                { name: '#app-content', selector: '#app-content' },
                { name: '#notification-container', selector: '#notification-container' },
                { name: '#modal-container', selector: '#modal-container' }
            ];
            
            const results = elements.map(element => ({
                name: element.name,
                exists: !!document.querySelector(element.selector),
                status: !!document.querySelector(element.selector) ? 'success' : 'error'
            }));
            
            const domStatusDiv = document.getElementById('dom-status');
            domStatusDiv.innerHTML = results.map(result => {
                const statusClass = result.status === 'success' ? 'status-success' : 'status-error';
                const icon = result.status === 'success' ? '✅' : '❌';
                return `<div class="${statusClass}">${icon} ${result.name}: ${result.exists ? 'Found' : 'Missing'}</div>`;
            }).join('');
            
            return results;
        }
        
        function runSystemCheck() {
            console.log('🔍 Running comprehensive system check...');
            
            const scriptResults = checkScriptLoading();
            const coreResults = checkCoreSystemsStatus();
            const domResults = checkDOMElements();
            
            // Overall system status
            const allResults = [...scriptResults, ...coreResults, ...domResults];
            const successCount = allResults.filter(r => r.status === 'success').length;
            const totalCount = allResults.length;
            const successRate = Math.round((successCount / totalCount) * 100);
            
            const overviewDiv = document.getElementById('system-overview');
            let overallStatus = 'success';
            let overallMessage = `System Status: ${successCount}/${totalCount} components OK (${successRate}%)`;
            
            if (successRate < 100) {
                overallStatus = successRate >= 80 ? 'warning' : 'error';
            }
            
            const statusClass = overallStatus === 'success' ? 'status-success' : 
                              overallStatus === 'warning' ? 'status-warning' : 'status-error';
            const icon = overallStatus === 'success' ? '✅' : 
                       overallStatus === 'warning' ? '⚠️' : '❌';
            
            overviewDiv.innerHTML = `<div class="${statusClass}">${icon} ${overallMessage}</div>`;
            
            // Generate recommendations
            generateRecommendations(scriptResults, coreResults, domResults);
            
            console.log('✅ System check completed');
        }
        
        function generateRecommendations(scriptResults, coreResults, domResults) {
            const recommendations = [];
            
            // Check for missing scripts
            const missingScripts = scriptResults.filter(r => !r.loaded);
            if (missingScripts.length > 0) {
                recommendations.push({
                    type: 'error',
                    message: `Missing scripts: ${missingScripts.map(s => s.name).join(', ')}. Check script loading order and CDN availability.`
                });
            }
            
            // Check for core system errors
            const failedSystems = coreResults.filter(r => r.status === 'error');
            if (failedSystems.length > 0) {
                recommendations.push({
                    type: 'error',
                    message: `Failed core systems: ${failedSystems.map(s => s.name).join(', ')}. Check for redeclaration errors and initialization sequence.`
                });
            }
            
            // Check for missing DOM elements
            const missingElements = domResults.filter(r => !r.exists);
            if (missingElements.length > 0) {
                recommendations.push({
                    type: 'error',
                    message: `Missing DOM elements: ${missingElements.map(e => e.name).join(', ')}. Ensure HTML structure is complete.`
                });
            }
            
            // Success message
            if (recommendations.length === 0) {
                recommendations.push({
                    type: 'success',
                    message: '🎉 All systems are functioning correctly! The app should initialize without errors.'
                });
            }
            
            const recommendationsDiv = document.getElementById('recommendations');
            recommendationsDiv.innerHTML = recommendations.map(rec => {
                const statusClass = rec.type === 'success' ? 'status-success' : 
                                  rec.type === 'warning' ? 'status-warning' : 'status-error';
                const icon = rec.type === 'success' ? '✅' : 
                           rec.type === 'warning' ? '⚠️' : '❌';
                return `<div class="${statusClass}">${icon} ${rec.message}</div>`;
            }).join('');
        }
        
        async function testInitialization() {
            const initDiv = document.getElementById('init-sequence');
            initDiv.innerHTML = '<div class="status-info">🚀 Testing app initialization...</div>';
            
            try {
                // Test if App class exists and can be instantiated
                if (typeof window.App === 'undefined') {
                    throw new Error('App class not loaded');
                }
                
                // Try to create app instance
                const testApp = new window.App();
                
                initDiv.innerHTML = '<div class="status-success">✅ App initialization test passed!</div>';
            } catch (error) {
                initDiv.innerHTML = `<div class="status-error">❌ App initialization failed: ${error.message}</div>`;
            }
        }
        
        // Run initial system check when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚨 Initialization Debug Tool loaded');
            setTimeout(runSystemCheck, 1000); // Give scripts time to load
        });
    </script>

    <!-- Load core scripts -->
    <script src="config/constants.js"></script>
    <script src="js/utils/helpers.js"></script>
    <script src="js/core/error-handler.js"></script>
    <script src="js/core/state-manager.js"></script>
    <script src="js/core/event-manager.js"></script>
    <script src="js/core/router.js"></script>
    <script src="js/wallet/network-manager.js"></script>
    <script src="js/wallet/wallet-manager.js"></script>
    <script src="js/contracts/contract-manager.js"></script>
    <script src="js/components/base-component.js"></script>
    <script src="js/components/notification.js"></script>
    <script src="js/components/modal.js"></script>
    <script src="js/pages/home.js"></script>
    <script src="js/pages/admin.js"></script>
    <script src="js/core/app.js"></script>
</body>
</html>
